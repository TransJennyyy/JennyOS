
section .data
    global StartStack
    global EEFlags
    StartStack dd 0
    EEFlags dd 0
    extern MallocSpinLock


section .text

extern IDThandler
extern CMalloc
extern CFree
extern AfterDelay

%macro IDTENTRYMAC 1

global IDTENTRY%1
IDTENTRY%1:
    pushf
    mov [StartStack], dword esp ; only for debuging
    pushad
    
    mov ebp, esp

    push ebp ; input 2
    push %1 ; input 1
    call IDThandler ; func call
    pop eax
    pop ebp

    .OnExit:
    mov esp, ebp


    .Skiped:
    popad
    popf
    iret


%endmacro

TmpReg dd 0
global GetIdtRegistors
GetIdtRegistors:
    pusha
    push ebp
    mov eax, [esp+4]
    mov eax, [eax]

    mov [TmpReg], dword esp

    mov esp, eax
    popf
    popa
    pusha
    pushf

    mov esp, [TmpReg]
    
    mov edi, [esp+8]
    mov edi, [edi]
    mov [edi], dword 0
    mov [edi+4], dword 0
    mov [edi+8], dword 0
    mov [edi+12], dword 0
    mov [edi+16], dword 0
    
    pop ebp
    popa
    ret





IDTENTRYMAC 0
IDTENTRYMAC 1
IDTENTRYMAC 2
IDTENTRYMAC 3
IDTENTRYMAC 4
IDTENTRYMAC 5
IDTENTRYMAC 6
IDTENTRYMAC 7
IDTENTRYMAC 8
IDTENTRYMAC 9
IDTENTRYMAC 10
IDTENTRYMAC 11
IDTENTRYMAC 12
IDTENTRYMAC 13
IDTENTRYMAC 14
IDTENTRYMAC 15
IDTENTRYMAC 16
IDTENTRYMAC 17
IDTENTRYMAC 18
IDTENTRYMAC 19
IDTENTRYMAC 20
IDTENTRYMAC 21
IDTENTRYMAC 22
IDTENTRYMAC 23
IDTENTRYMAC 24
IDTENTRYMAC 25
IDTENTRYMAC 26
IDTENTRYMAC 27
IDTENTRYMAC 28
IDTENTRYMAC 29
IDTENTRYMAC 30
IDTENTRYMAC 31
IDTENTRYMAC 32
IDTENTRYMAC 33
IDTENTRYMAC 34
IDTENTRYMAC 35
IDTENTRYMAC 36
IDTENTRYMAC 37
IDTENTRYMAC 38
IDTENTRYMAC 39
IDTENTRYMAC 40
IDTENTRYMAC 41
IDTENTRYMAC 42
IDTENTRYMAC 43
IDTENTRYMAC 44
IDTENTRYMAC 45
IDTENTRYMAC 46
IDTENTRYMAC 47
IDTENTRYMAC 48
IDTENTRYMAC 49
IDTENTRYMAC 50
IDTENTRYMAC 51
IDTENTRYMAC 52
IDTENTRYMAC 53
IDTENTRYMAC 54
IDTENTRYMAC 55
IDTENTRYMAC 56
IDTENTRYMAC 57
IDTENTRYMAC 58
IDTENTRYMAC 59
IDTENTRYMAC 60
IDTENTRYMAC 61
IDTENTRYMAC 62
IDTENTRYMAC 63
IDTENTRYMAC 64
IDTENTRYMAC 65
IDTENTRYMAC 66
IDTENTRYMAC 67
IDTENTRYMAC 68
IDTENTRYMAC 69
IDTENTRYMAC 70
IDTENTRYMAC 71
IDTENTRYMAC 72
IDTENTRYMAC 73
IDTENTRYMAC 74
IDTENTRYMAC 75
IDTENTRYMAC 76
IDTENTRYMAC 77
IDTENTRYMAC 78
IDTENTRYMAC 79
IDTENTRYMAC 80
IDTENTRYMAC 81
IDTENTRYMAC 82
IDTENTRYMAC 83
IDTENTRYMAC 84
IDTENTRYMAC 85
IDTENTRYMAC 86
IDTENTRYMAC 87
IDTENTRYMAC 88
IDTENTRYMAC 89
IDTENTRYMAC 90
IDTENTRYMAC 91
IDTENTRYMAC 92
IDTENTRYMAC 93
IDTENTRYMAC 94
IDTENTRYMAC 95
IDTENTRYMAC 96
IDTENTRYMAC 97
IDTENTRYMAC 98
IDTENTRYMAC 99
IDTENTRYMAC 100
IDTENTRYMAC 101
IDTENTRYMAC 102
IDTENTRYMAC 103
IDTENTRYMAC 104
IDTENTRYMAC 105
IDTENTRYMAC 106
IDTENTRYMAC 107
IDTENTRYMAC 108
IDTENTRYMAC 109
IDTENTRYMAC 110
IDTENTRYMAC 111
IDTENTRYMAC 112
IDTENTRYMAC 113
IDTENTRYMAC 114
IDTENTRYMAC 115
IDTENTRYMAC 116
IDTENTRYMAC 117
IDTENTRYMAC 118
IDTENTRYMAC 119
IDTENTRYMAC 120
IDTENTRYMAC 121
IDTENTRYMAC 122
IDTENTRYMAC 123
IDTENTRYMAC 124
IDTENTRYMAC 125
IDTENTRYMAC 126
IDTENTRYMAC 127
IDTENTRYMAC 128
IDTENTRYMAC 129
IDTENTRYMAC 130
IDTENTRYMAC 131
IDTENTRYMAC 132
IDTENTRYMAC 133
IDTENTRYMAC 134
IDTENTRYMAC 135
IDTENTRYMAC 136
IDTENTRYMAC 137
IDTENTRYMAC 138
IDTENTRYMAC 139
IDTENTRYMAC 140
IDTENTRYMAC 141
IDTENTRYMAC 142
IDTENTRYMAC 143
IDTENTRYMAC 144
IDTENTRYMAC 145
IDTENTRYMAC 146
IDTENTRYMAC 147
IDTENTRYMAC 148
IDTENTRYMAC 149
IDTENTRYMAC 150
IDTENTRYMAC 151
IDTENTRYMAC 152
IDTENTRYMAC 153
IDTENTRYMAC 154
IDTENTRYMAC 155
IDTENTRYMAC 156
IDTENTRYMAC 157
IDTENTRYMAC 158
IDTENTRYMAC 159
IDTENTRYMAC 160
IDTENTRYMAC 161
IDTENTRYMAC 162
IDTENTRYMAC 163
IDTENTRYMAC 164
IDTENTRYMAC 165
IDTENTRYMAC 166
IDTENTRYMAC 167
IDTENTRYMAC 168
IDTENTRYMAC 169
IDTENTRYMAC 170
IDTENTRYMAC 171
IDTENTRYMAC 172
IDTENTRYMAC 173
IDTENTRYMAC 174
IDTENTRYMAC 175
IDTENTRYMAC 176
IDTENTRYMAC 177
IDTENTRYMAC 178
IDTENTRYMAC 179
IDTENTRYMAC 180
IDTENTRYMAC 181
IDTENTRYMAC 182
IDTENTRYMAC 183
IDTENTRYMAC 184
IDTENTRYMAC 185
IDTENTRYMAC 186
IDTENTRYMAC 187
IDTENTRYMAC 188
IDTENTRYMAC 189
IDTENTRYMAC 190
IDTENTRYMAC 191
IDTENTRYMAC 192
IDTENTRYMAC 193
IDTENTRYMAC 194
IDTENTRYMAC 195
IDTENTRYMAC 196
IDTENTRYMAC 197
IDTENTRYMAC 198
IDTENTRYMAC 199
IDTENTRYMAC 200
IDTENTRYMAC 201
IDTENTRYMAC 202
IDTENTRYMAC 203
IDTENTRYMAC 204
IDTENTRYMAC 205
IDTENTRYMAC 206
IDTENTRYMAC 207
IDTENTRYMAC 208
IDTENTRYMAC 209
IDTENTRYMAC 210
IDTENTRYMAC 211
IDTENTRYMAC 212
IDTENTRYMAC 213
IDTENTRYMAC 214
IDTENTRYMAC 215
IDTENTRYMAC 216
IDTENTRYMAC 217
IDTENTRYMAC 218
IDTENTRYMAC 219
IDTENTRYMAC 220
IDTENTRYMAC 221
IDTENTRYMAC 222
IDTENTRYMAC 223
IDTENTRYMAC 224
IDTENTRYMAC 225
IDTENTRYMAC 226
IDTENTRYMAC 227
IDTENTRYMAC 228
IDTENTRYMAC 229
IDTENTRYMAC 230
IDTENTRYMAC 231
IDTENTRYMAC 232
IDTENTRYMAC 233
IDTENTRYMAC 234
IDTENTRYMAC 235
IDTENTRYMAC 236
IDTENTRYMAC 237
IDTENTRYMAC 238
IDTENTRYMAC 239
IDTENTRYMAC 240
IDTENTRYMAC 241
IDTENTRYMAC 242
IDTENTRYMAC 243
IDTENTRYMAC 244
IDTENTRYMAC 245
IDTENTRYMAC 246
IDTENTRYMAC 247
IDTENTRYMAC 248
IDTENTRYMAC 249
IDTENTRYMAC 250
IDTENTRYMAC 251
IDTENTRYMAC 252
IDTENTRYMAC 253
IDTENTRYMAC 254
IDTENTRYMAC 255

global ReadEFlags

ReadEFlags:
    pushf
    pop eax
    ret
